name: Build and Deploy to EC2

on:
  push:
    branches:
      - main
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

    steps:
      - name: ðŸ§¾ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ“¦ Install dependencies
        run: npm install

      - name: ðŸ› ï¸ Build the app
        run: npm run build

      - name: ðŸ” Set up SSH key and known hosts
        run: |
          mkdir -p /tmp/ssh
          echo "$SSH_PRIVATE_KEY" > /tmp/ssh/windsshkey
          chmod 600 /tmp/ssh/windsshkey

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to EC2
        run: |
          ssh -i /tmp/ssh/windsshkey $EC2_USER@$EC2_HOST "echo Connected!"
          ssh -i /tmp/ssh/windsshkey $EC2_USER@$EC2_HOST "mkdir -p ~/myapp"

          rsync -avz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.github' \
            -e "ssh -i /tmp/ssh/windsshkey" \
            . $EC2_USER@$EC2_HOST:~/myapp/

          ssh -i /tmp/ssh/windsshkey $EC2_USER@$EC2_HOST << 'EOF'
            cd ~/myapp

            pm2 reload myapp || true
            pm2 start dist/server.js --name myapp
          EOF
